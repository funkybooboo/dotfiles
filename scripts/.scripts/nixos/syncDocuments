#!/run/current-system/sw/bin/bash
#
# sync.sh
# Bidirectional sync between ~/Documents and the "Documents" folder
# on Proton Drive using rclone bisync.
#
set -euo pipefail

# 0) Refresh Proton Drive 2FA via CLI
if ! /home/nate/.local/bin/update-rclone-2fa; then
    echo "[$(date +'%Y-%m-%dT%H:%M:%S%:z')] ❌ Failed to update 2FA — sync aborted" >>"${HOME}/.local/state/sync.log"
    exit 1
fi

# 1) Local directory to sync
LOCAL_DIR="${HOME}/Documents"

# 2) Remote path on Proton Drive
REMOTE_PATH="proton:Documents"

# 3) Log directory + file
LOG_DIR="${HOME}/.local/state"
LOGFILE="${LOG_DIR}/sync.log"

# 4) Bisync cache‐listing path under ~/.cache/rclone
CACHE_BASE="${HOME}/.cache/rclone/bisync"
PATH1_LIST="${CACHE_BASE}/home_nate_Documents..proton_Documents.path1.lst"
PATH2_LIST="${CACHE_BASE}/home_nate_Documents..proton_Documents.path2.lst"

# 5) Ensure the local folder exists
if [ ! -d "${LOCAL_DIR}" ]; then
    echo "Error: Local directory ${LOCAL_DIR} does not exist." >&2
    exit 1
fi

# 6) Ensure the log directory exists
if [ ! -d "${LOG_DIR}" ]; then
    mkdir -p "${LOG_DIR}"
    chmod 755 "${LOG_DIR}"
fi

# 7) Ensure the remote “Documents” directory exists on Proton Drive
if ! /run/current-system/sw/bin/rclone lsd "${REMOTE_PATH}" >/dev/null 2>&1; then
    /run/current-system/sw/bin/rclone mkdir "${REMOTE_PATH}"
fi

# 8) Determine if this is the first run and needs --resync
USE_RESYNC=""
if [ ! -f "${PATH1_LIST}" ] || [ ! -f "${PATH2_LIST}" ]; then
    USE_RESYNC="--resync"
    echo "[$(date +'%Y-%m-%dT%H:%M:%S%:z')] First run: initializing bisync state (using --resync)" >>"${LOGFILE}"
fi

# 9) Run rclone bisync
/run/current-system/sw/bin/rclone bisync \
    "${LOCAL_DIR}" \
    "${REMOTE_PATH}" \
    --delete-during \
    --verbose \
    --log-file="${LOGFILE}" \
    ${USE_RESYNC:+$USE_RESYNC}

# 10) Record completion
echo "[$(date +'%Y-%m-%dT%H:%M:%S%:z')] Sync completed" >>"${LOGFILE}"
