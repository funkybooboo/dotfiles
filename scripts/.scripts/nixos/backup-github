#!/run/current-system/sw/bin/bash
set -euo pipefail

# â”€â”€â”€ 0) Check required commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for cmd in gh git curl jq rclone flock; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "Error: '$cmd' not found." >&2
    exit 1
  }
done

# â”€â”€â”€ 1) Load & export tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "${HOME}/.tokens" ]]; then
  set -a; source "${HOME}/.tokens"; set +a
else
  echo "Error: ~/.tokens not found." >&2
  exit 1
fi
: "${GH_TOKEN:?need GH_TOKEN in ~/.tokens}"
: "${GITLAB_TOKEN:?need GITLAB_TOKEN in ~/.tokens}"

# â”€â”€â”€ 2) Prevent overlapping runs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BACKUP_DIR="${HOME}/backups/github"
mkdir -p "$BACKUP_DIR"
LOCKFILE="${BACKUP_DIR}/backup-github.lock"
exec 200>"$LOCKFILE"
flock -n 200 || { echo "Already running; exiting."; exit 0; }

# â”€â”€â”€ 3) Verify Proton remote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rclone listremotes | grep -q '^proton:' || {
  echo "Error: rclone remote 'proton:' missing." >&2
  exit 1
}

# â”€â”€â”€ 4) Identities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GH_USER="$(gh api user --jq .login)"
GL_USER_ID="$(curl -s -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" \
  https://gitlab.com/api/v4/user | jq -r .id)"
GL_NAMESPACE="$GH_USER"

# â”€â”€â”€ 5) List your GitHub repos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "â³ Listing GitHub repos for $GH_USERâ€¦"
mapfile -t REPOS < <(
  gh repo list "$GH_USER" --limit 1000 --json name -q '.[].name'
)

# â”€â”€â”€ 6) Mirror & push each repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for repo in "${REPOS[@]}"; do
  echo; echo "ğŸ“¦ Processing $repo"
  REPO_DIR="${BACKUP_DIR}/${repo}.git"

  # Clone or fetch
  if [[ ! -d "$REPO_DIR" ]]; then
    echo "  â†’ Cloning mirror via HTTPSâ€¦"
    git clone --mirror \
      "https://${GH_TOKEN}@github.com/${GH_USER}/${repo}.git" \
      "$REPO_DIR"
  else
    echo "  â†’ Fetching updatesâ€¦"
    git --git-dir="$REPO_DIR" fetch --all --prune
  fi

  # Fetch or create project
  ENCODED_PATH="$(printf '%s/%s' "$GL_NAMESPACE" "$repo" | sed 's_/_%2F_g')"
  PROJ_INFO="$(curl -s -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" \
    "https://gitlab.com/api/v4/projects/${ENCODED_PATH}")"
  if ! echo "$PROJ_INFO" | jq -e .id >/dev/null; then
    echo "  â†’ Creating $repo on GitLabâ€¦"
    PROJ_INFO="$(curl -s -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" -X POST \
      "https://gitlab.com/api/v4/projects" \
      -d "name=${repo}" \
      -d "namespace_id=${GL_USER_ID}" \
      -d "visibility=private" \
      -d "import_url=https://github.com/${GH_USER}/${repo}.git")"
  fi

  PROJ_ID="$(echo "$PROJ_INFO" | jq -r .id)"
  DEFAULT_BRANCH="$(echo "$PROJ_INFO" | jq -r '.default_branch // "main"')"
  echo "  â†’ default branch is $DEFAULT_BRANCH"

  # â”€â”€â”€ 7) Unprotect the default branch safely â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Try to fetch protected branches; fall back to empty array on error
  PROTECTED_JSON="$(curl -sf -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" \
    "https://gitlab.com/api/v4/projects/${PROJ_ID}/protected_branches" \
    || echo '[]')"

  # Look up any rule ID
  RULE_ID="$(echo "$PROTECTED_JSON" | jq -r \
    ".[] | select(.name==\"${DEFAULT_BRANCH}\") | .id")"

  if [[ -n "$RULE_ID" && "$RULE_ID" != "null" ]]; then
    echo "  â†’ Unprotecting branch via rule ID $RULE_IDâ€¦"
    curl -s -X DELETE -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" \
      "https://gitlab.com/api/v4/projects/${PROJ_ID}/protected_branches/${RULE_ID}" \
      >/dev/null || true
  fi

  # Also delete by branch name endpoint (idempotent)
  echo "  â†’ Ensuring unprotected by branch-name endpointâ€¦"
  curl -s -X DELETE -H "PRIVATE-TOKEN:${GITLAB_TOKEN}" \
    "https://gitlab.com/api/v4/projects/${PROJ_ID}/protected_branches/${DEFAULT_BRANCH}" \
    >/dev/null || true

  # â”€â”€â”€ 8) Push the mirror â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  echo "  â†’ Pushing mirror to GitLabâ€¦"
  git --git-dir="$REPO_DIR" push --mirror \
    "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GL_NAMESPACE}/${repo}.git"
done

# â”€â”€â”€ 9) Snapshot to Proton Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo; echo "â˜ï¸  Syncing to Proton Driveâ€¦"
rclone sync "$BACKUP_DIR" proton:Backups/GitHub --create-empty-src-dirs

echo "âœ… Backup complete!"
