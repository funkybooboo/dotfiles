#!/usr/bin/env bash
# Bidirectional sync script for syncing directories with NAS
# Usage: sync-to-nas <local_dir> <rsync_module> <username>

set -euo pipefail

if [ $# -ne 3 ]; then
    echo "Usage: $0 <local_dir> <rsync_module> <username>"
    echo "Example: $0 ~/Documents documents nate"
    exit 1
fi

LOCAL_DIR="$1"
RSYNC_MODULE="$2"
USERNAME="$3"
NAS_IP="192.168.8.238"
NAS_PORT="873"

# Password file location (will be created separately)
PASSWORD_FILE="$HOME/.config/nas-sync/rsync-password"

# Check if NAS is reachable
if ! "$HOME/.local/bin/nas/check-nas-connection"; then
    echo "NAS not reachable. Skipping sync."
    exit 0
fi

# Check if password file exists
if [ ! -f "$PASSWORD_FILE" ]; then
    echo "Error: Password file not found at $PASSWORD_FILE"
    echo "Create it with: echo 'your_password' > $PASSWORD_FILE && chmod 600 $PASSWORD_FILE"
    exit 1
fi

# Ensure local directory exists
mkdir -p "$LOCAL_DIR"

# Rsync options:
# -a: archive mode (preserve permissions, times, etc.)
# -v: verbose
# -z: compress during transfer
# -u: skip files that are newer on receiver
# --delete: delete files that don't exist on sender
# --progress: show progress
# --password-file: use password from file

RSYNC_OPTS="-avzu --delete --progress --password-file=$PASSWORD_FILE"
REMOTE="rsync://$USERNAME@$NAS_IP:$NAS_PORT/$RSYNC_MODULE/"

echo "=== Syncing $LOCAL_DIR with NAS module $RSYNC_MODULE ==="

# First: Sync local → NAS (upload changes)
echo "--- Uploading local changes to NAS ---"
rsync $RSYNC_OPTS "$LOCAL_DIR/" "$REMOTE"

# Second: Sync NAS → local (download changes)
echo "--- Downloading NAS changes to local ---"
rsync $RSYNC_OPTS "$REMOTE" "$LOCAL_DIR/"

echo "=== Sync complete ==="
