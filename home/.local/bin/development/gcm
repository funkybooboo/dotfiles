#!/usr/bin/env bash

set -euo pipefail

# Get git diff output - try multiple sources to always find changes
# First try staged changes
DIFF=$(git diff --cached)

# If no staged changes, try unstaged changes
if [ -z "$DIFF" ]; then
  DIFF=$(git diff)
fi

# If still nothing, try all changes from HEAD
if [ -z "$DIFF" ]; then
  DIFF=$(git diff HEAD)
fi

# If still nothing, there are truly no changes
if [ -z "$DIFF" ]; then
  echo "Error: No changes detected (staged, unstaged, or from HEAD)" >&2
  exit 1
fi

# Prepare the prompt for Claude
PROMPT="Analyze this git diff and generate a concise, clear commit message following conventional commit format.

The commit message should:
- Start with a type (feat/fix/docs/style/refactor/test/chore)
- Be concise (50-72 characters for the subject line)
- Focus on WHY the change was made, not just WHAT changed
- Use imperative mood (\"add\" not \"added\" or \"adds\")

Git diff:
\`\`\`
${DIFF}
\`\`\`

Respond with ONLY the commit message, nothing else."

# Use opencode CLI to generate commit message
opencode run "$PROMPT"
