#!/usr/bin/env bash
#
# good-time-to-run — exit 0 if on AC, idle, and low load; else exit 1
#
set -euo pipefail

TS() { date '+%F %T'; }

echo "[$(TS)] Checking if this is a good time to run…"

# 1) Check AC power
AC_POWER_FILE="/sys/class/power_supply/AC*/online"
BATTERY_STATUS_FILE="/sys/class/power_supply/BAT*/status"

if grep -q "Discharging" $BATTERY_STATUS_FILE 2>/dev/null; then
    echo "[$(TS)] NOT OK: On battery power"
    exit 1
fi

if ! grep -q 1 $AC_POWER_FILE 2>/dev/null; then
    echo "[$(TS)] NOT OK: AC adapter not detected"
    exit 1
fi

# 2) Check idle
IDLE_MS=0
if command -v xprintidle >/dev/null 2>&1; then
    IDLE_MS=$(xprintidle 2>/dev/null || echo 0)
    if [[ "$IDLE_MS" -eq 0 ]]; then
        echo "[$(TS)] xprintidle failed (Wayland?), falling back to loginctl"
    elif ((IDLE_MS < 600000)); then
        echo "[$(TS)] NOT OK: User active (X11 idle ${IDLE_MS}ms)"
        exit 1
    fi
fi

# Wayland-friendly fallback: check if the current user is idle
if [[ "$IDLE_MS" -eq 0 ]]; then
    IdleHint=$(loginctl show-user "$USER" -p IdleHint --value 2>/dev/null || echo "no")
    if [[ "$IdleHint" != "yes" ]]; then
        echo "[$(TS)] NOT OK: User active (IdleHint=$IdleHint)"
        exit 1
    fi
fi

# 3) Check system load
LOAD=$(cut -d. -f1 /proc/loadavg)
if ((LOAD > 2)); then
    echo "[$(TS)] NOT OK: System load is high ($LOAD)"
    exit 1
fi

echo "[$(TS)] OK: Good time to run"
exit 0
