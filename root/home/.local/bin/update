#!/usr/bin/env bash
# System update script for Arch Linux with Omarchy

set -euo pipefail

echo "=== System Update (Arch Linux) ==="
echo ""

# Step 1: Update Arch packages with yay (AUR helper)
if command -v yay >/dev/null 2>&1; then
    echo "→ Updating Arch/AUR packages (yay)..."
    yay -Syu --noconfirm
    echo ""
else
    echo "→ yay not found, using pacman..."
    sudo pacman -Syu --noconfirm
    echo ""
fi

# Step 2: Update Flatpak applications
if command -v flatpak >/dev/null 2>&1; then
    echo "→ Updating Flatpak applications..."
    flatpak update -y
    echo ""
fi

# Step 3: Update Omarchy
if command -v omarchy-update >/dev/null 2>&1; then
    echo "→ Updating Omarchy..."
    omarchy-update
    echo ""
fi

# Step 3b: Advance dotfiles submodule pin to match the pulled omarchy commit
# Resolve the real path of this script to find the dotfiles repo root.
# Script lives at dotfiles/root/home/.local/bin/update — 4 levels deep.
_SCRIPT_REAL="$(readlink -f "${BASH_SOURCE[0]}")"
_DOTFILES_DIR="$(cd "$(dirname "$_SCRIPT_REAL")/../../../.." && pwd)"
if [[ -f "$_DOTFILES_DIR/.gitmodules" ]] && grep -q "omarchy" "$_DOTFILES_DIR/.gitmodules" 2>/dev/null; then
    _OMARCHY_SUBMOD="root/home/.local/share/omarchy"
    echo "→ Updating omarchy submodule pin in dotfiles..."
    if git -C "$_DOTFILES_DIR" submodule update --remote "$_OMARCHY_SUBMOD" 2>/dev/null; then
        if ! git -C "$_DOTFILES_DIR" diff --quiet HEAD -- "$_OMARCHY_SUBMOD" 2>/dev/null; then
            git -C "$_DOTFILES_DIR" add "$_OMARCHY_SUBMOD"
            git -C "$_DOTFILES_DIR" commit -m "chore: advance omarchy submodule pin"
            echo "  dotfiles submodule pin updated and committed"
        else
            echo "  omarchy submodule pin already up to date"
        fi
    else
        echo "  warning: could not update omarchy submodule — skipping pin update"
    fi
    echo ""
fi

# Step 4: Update firmware
if command -v fwupdmgr >/dev/null 2>&1; then
    echo "→ Checking for firmware updates..."
    fwupdmgr refresh || true
    fwupdmgr update || echo "No firmware updates available"
    echo ""
fi

# Step 5: Update Rust packages
if command -v cargo >/dev/null 2>&1; then
    echo "→ Updating Rust packages..."
    cargo install cargo-update 2>/dev/null || true
    cargo install-update -a || echo "cargo-update not installed"
    echo ""
fi

# Step 6: Update Go packages
if command -v go >/dev/null 2>&1 && [ -d "$HOME/go/bin" ]; then
    echo "→ Updating Go packages..."
    for bin in "$HOME/go/bin/"*; do
        [ -f "$bin" ] || continue
        pkg_name=$(basename "$bin")
        echo "  → Reinstalling $pkg_name..."
        go install "$pkg_name@latest" 2>/dev/null || true
    done
    echo ""
fi

# Step 7: Clean package cache
if command -v yay >/dev/null 2>&1; then
    echo "→ Cleaning package cache..."
    yay -Sc --noconfirm
    echo ""
fi

echo "=== Update Complete ==="
