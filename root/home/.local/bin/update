#!/usr/bin/env bash
# System update script for Arch Linux with Omarchy

set -euo pipefail

echo "=== System Update (Arch Linux) ==="
echo ""

# Step 1: Update Arch packages with yay (AUR helper)
if command -v yay >/dev/null 2>&1; then
    echo "→ Updating Arch/AUR packages (yay)..."
    yay -Syu --noconfirm
    echo ""
else
    echo "→ yay not found, using pacman..."
    sudo pacman -Syu --noconfirm
    echo ""
fi

# Step 2: Update Flatpak applications
if command -v flatpak >/dev/null 2>&1; then
    echo "→ Updating Flatpak applications..."
    flatpak update -y
    echo ""
fi

# Step 3: Update Omarchy
if command -v omarchy-update >/dev/null 2>&1; then
    echo "→ Updating Omarchy..."
    omarchy-update
    echo ""
fi

# Step 4: Update firmware
if command -v fwupdmgr >/dev/null 2>&1; then
    echo "→ Checking for firmware updates..."
    fwupdmgr refresh || true
    fwupdmgr update || echo "No firmware updates available"
    echo ""
fi

# Step 5: Update Rust packages
if command -v cargo >/dev/null 2>&1; then
    echo "→ Updating Rust packages..."
    cargo install cargo-update 2>/dev/null || true
    cargo install-update -a || echo "cargo-update not installed"
    echo ""
fi

# Step 6: Update Go packages
if command -v go >/dev/null 2>&1 && [ -d "$HOME/go/bin" ]; then
    echo "→ Updating Go packages..."
    for bin in "$HOME/go/bin/"*; do
        [ -f "$bin" ] || continue
        pkg_name=$(basename "$bin")
        echo "  → Reinstalling $pkg_name..."
        go install "$pkg_name@latest" 2>/dev/null || true
    done
    echo ""
fi

# Step 7: Clean package cache
if command -v yay >/dev/null 2>&1; then
    echo "→ Cleaning package cache..."
    yay -Sc --noconfirm
    echo ""
fi

echo "=== Update Complete ==="
